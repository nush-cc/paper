// Production Model
digraph "MODWT-MoE_Architecture" {
	rankdir=LR size="12,8" splines=ortho
	node [fontname=Helvetica fontsize=10 shape=box style=filled]
	subgraph cluster_0 {
		color=grey label="Data Preparation & Feature Engineering" style=dashed
		node [fillcolor=lightblue]
		RawData [label="Raw Data
(USD_TWD.csv)"]
		Features [label="Feature Engineering
(LogRet, Volatility, RSI)"]
		Scaler [label="StandardScaler
(Z-Score Norm)"]
		RawData -> Features
		Features -> Scaler
	}
	subgraph cluster_1 {
		color="#e0a800" label="MODWT Decomposition (Level 4)" style=rounded
		node [fillcolor="#fff3cd"]
		MODWT [label="MODWT Algorithm
(db4 Wavelet)"]
		Trend [label="Trend Component
(cA4)" fillcolor="#ffeba1"]
		Cyclic [label="Cyclic Components
(cD4, cD3)" fillcolor="#ffeba1"]
		HighFreq [label="High-Freq Components
(cD2, cD1)" fillcolor="#ffeba1"]
		Scaler -> MODWT [label="Volatility Signal"]
		MODWT -> Trend
		MODWT -> Cyclic
		MODWT -> HighFreq
	}
	subgraph cluster_base {
		color="#28a745" fillcolor="#e6fffa" label="Base Branch (Anchor)" style=filled
		RawInput [label="Raw Input
[Vol, RSI, Ret]" fillcolor=white]
		RawLSTM [label="RawLSTM
(2 Layers, Hidden=64)" fillcolor="#90ee90"]
		BaseDelta [label="Base Prediction
(Δ_base)" fillcolor=white shape=ellipse]
		RawInput -> RawLSTM
		RawLSTM -> BaseDelta
	}
	subgraph cluster_experts {
		color="#dc3545" fillcolor="#fff5f5" label="Expert Branch (Residual Correction)" style=filled
		Exp1 [label="Trend Expert
(GRU + Attention)" fillcolor="#ffcccb"]
		Exp2 [label="Cyclic Expert
(GRU + Attention)" fillcolor="#ffcccb"]
		Exp3 [label="High-Freq Expert
(GRU + Attention)" fillcolor="#ffcccb"]
		Attn [label="Temporal Attention
Weights" fillcolor=white fontsize=8 shape=note]
		Context [label="Context Vector (Size=13)
[Last Wavelets + Mean Wavelets + Raw Last]" fillcolor="#e0e0e0"]
		GatingNet [label="Gating Network
(Softmax)" fillcolor="#d63384" fontcolor=white]
		MetaGate [label="Meta-Gate (α)
(Sigmoid)" fillcolor="#6610f2" fontcolor=white]
		MoESum [label="MoE Aggregation
Σ (w_i * Expert_i)" fillcolor=white shape=diamond]
		Exp1 -> Attn [style=dotted]
		Exp1 -> MoESum
		Exp2 -> MoESum
		Exp3 -> MoESum
		Context -> GatingNet
		Context -> MetaGate
		GatingNet -> MoESum [label=Weights]
	}
	subgraph cluster_2 {
		color=black label="Advanced Residual MODWT-MoE Architecture" style=bold
		node [shape=rect]
		Fusion [label="Residual Fusion
Δ_total = Δ_base + (α * Δ_moe)" fillcolor="#fd7e14" shape=Mrecord style=filled]
		BaseDelta -> Fusion
		MoESum -> Fusion [label="Δ_moe"]
		MetaGate -> Fusion [label="α"]
	}
	subgraph cluster_3 {
		color=grey label="Output & Optimization"
		node [fillcolor=white]
		PrevVal [label="Previous Value
(t-1)" shape=oval]
		FinalPred [label="Final Prediction
(t)" fillcolor="#20c997" style=filled]
		Target [label="Ground Truth" shape=oval]
		Loss [label="HybridDirectionalLoss
(Huber + Tanh Penalty)" fillcolor="#ffc107" style=filled]
		Fusion -> FinalPred
		PrevVal -> FinalPred [label=Add]
		FinalPred -> Loss
		Target -> Loss
		PrevVal -> Loss [label="Direction Check" style=dotted]
	}
	Trend -> Exp1
	Cyclic -> Exp2
	HighFreq -> Exp3
	Trend -> Context [style=dotted]
	Cyclic -> Context [style=dotted]
	HighFreq -> Context [style=dotted]
	RawInput -> Context [style=dotted]
}
